{"version":3,"file":"anyFileReader.js","sources":["../template.js","../anyFileReader.ts"],"sourcesContent":["/**\n * @param {{ [key: string]: any }} opts\n * @returns {string}\n */\n function getCss(opts = {}) {\n  return `:host {\n  display: inline-block;\n  font-family: \"Arial\";\n}\ninput[type=\"file\"] {\n  position: absolute;\n  width: 1px;\n  height: 1px;\n  padding: 0;\n  overflow: hidden;\n  clip: rect(0, 0, 0, 0);\n  white-space: nowrap; /* 1 */\n  clip-path: inset(50%);\n  border: 0;\n}\n\nlabel {\n  padding: 0.3em;\n  border: 1px solid darkgrey;\n  border-radius: 5px;\n  cursor: pointer;\n}\n\nlabel:hover {\n  background-color: lightgrey;\n}\n\nlabel:focus {\n  outline: auto 1px rgb(77, 144, 254);\n}`\n}\n\n/**\n * @param {{ [key: string]: any }} opts\n * @returns {string}\n */\n function getHtml(opts = {}) {\n  return `<label tabindex=\"0\" for=\"file-upload\">${opts.label||\"\"}</label>\n<input tabindex=\"-1\" type=\"file\" name=\"file-data\" id=\"file-upload\" />`\n}\n\n/**\n * @type { {\n * render: (opts?: { label: string  }) => string\n * getHtml: (opts?: { [key: string]: any }) => string\n * getCss: (opts?: { label: string  }) => string\n * } }\n */\nconst Template = {\n  render(opts) {\n    return `<style>${this.getCss(opts)}</style>${this.getHtml(opts)}`\n  },\n  getHtml,\n  getCss,\n};\n\nexport { Template };\n","import { Template } from \"./template.js\"\n\nconst readingMethods = new Set([\n  \"readAsArrayBuffer\",\n  \"readAsBinaryString\",\n  \"readAsDataURL\",\n  \"readAsText\",\n] as const)\ntype ReadingMethods = typeof readingMethods extends Set<infer T> ? T : never\n\nclass AnyFileReader extends HTMLElement {\n  private root = this.attachShadow({ mode: \"open\" })!\n  private dom!: { input: HTMLInputElement; label: HTMLLabelElement }\n  private opts = { label: \"\" }\n  waitForFile!: AsyncGenerator\n  connectedCallback() {\n    this.root.innerHTML = Template.render(this.opts)\n    this.dom = {\n      input: this.root.querySelector(\"#file-upload\") as HTMLInputElement,\n      label: this.root.querySelector(\"label\") as HTMLLabelElement,\n    }\n\n    this.waitForFile = this.fileDataGenerator(\n      this.dom.input,\n      this.readingMethod,\n      this.fileType\n    )\n\n    // click on 'input' element when pressing enter on focused label:\n    this.dom.label.addEventListener(\"keydown\", (event: Event) => {\n      if ((event as KeyboardEvent).key === \"Enter\") {\n        this.dom.input.click()\n      }\n    })\n  }\n\n  private fileDataGenerator = async function*(\n    inputElement: HTMLInputElement,\n    readingMethod: ReadingMethods,\n    fileType: string | null\n  ) {\n    while (true) {\n      yield await new Promise((resolve, reject) => {\n        function handleFileSelection(event: Event) {\n          const files = inputElement.files\n          if (!files?.length) return reject(\"No file!\")\n          const file = files.item(0)!\n          if (typeof fileType === \"string\" && !validFileType(file, fileType))\n            reject(\"A file with wrong filetype was selected\")\n          return read(file, readingMethod)\n          function read(file: File, readingMethod: ReadingMethods) {\n            const reader = new FileReader()\n            reader[readingMethod](file)\n            return (reader.onload = (event: Event) => {\n              resolve(reader.result)\n            })\n          }\n        }\n        function validFileType(file: File, fileType: string) {\n          return fileType\n            .split(\",\")\n            .map((s: string) => s.trim())\n            .includes(file.type)\n        }\n        inputElement.addEventListener(\n          \"change\",\n          (event: Event) => handleFileSelection(event),\n          { once: true }\n        )\n      })\n    }\n  }\n\n  static get observedAttributes() {\n    return [\"reading-method\", \"file-type\", \"label\"]\n  }\n\n  attributeChangedCallback(\n    name: string,\n    oldValue: string | null,\n    newValue: string | null\n  ) {\n    if (newValue === oldValue) return\n    switch (name) {\n      case \"reading-method\":\n        if ((readingMethods as Set<any>).has(newValue)) return\n        else\n          return console.error(\n            \"The custom element 'any-file-reader' needs a valid 'reading-method' attribute: \" +\n              JSON.stringify([...readingMethods])\n          )\n        break\n      case \"file-type\":\n        // if (newValue === null) return this.removeAttribute(name)\n        break\n      case \"label\":\n        this.opts = { ...this.opts, [name]: newValue || \"\" }\n        this.root.innerHTML = Template.render(this.opts)\n        break\n      default:\n    }\n  }\n\n  get readingMethod(): ReadingMethods {\n    return this.getAttribute(\"reading-method\") as ReadingMethods\n  }\n  set readingMethod(value: ReadingMethods) {\n    this.setAttribute(\"reading-method\", value)\n  }\n  get fileType(): string | null {\n    return this.getAttribute(\"file-type\")\n  }\n  set fileType(value: string | null) {\n    if (value === null) this.removeAttribute(\"file-type\")\n    else this.setAttribute(\"file-type\", value)\n  }\n\n  static get is() {\n    return \"any-file-reader\"\n  }\n}\n\ncustomElements.define(AnyFileReader.is, AnyFileReader)\n\nexport { AnyFileReader }\n"],"names":[],"mappings":"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"}